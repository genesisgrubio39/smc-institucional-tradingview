//@version=6
indicator("SMC – OB Institucional (Módulo OB)",overlay=true,max_boxes_count=200,max_lines_count=200,max_labels_count=200)

//----------------------------------------------------
// 0. PRESET INSTITUCIONAL POR ACTIVO
//----------------------------------------------------
groupPreset = "0. Preset institucional"

presetMode = input.string("Auto por activo","Preset institucional",group=groupPreset,options=["Auto por activo","Futuros índice","ETF índice","MegaCap","Acción normal","Acción volátil","FX / Crypto","Personalizado"])

//----------------------------------------------------
// 1. INPUTS – LÓGICA INSTITUCIONAL (BASE)
//----------------------------------------------------
groupLogic  = "1. Lógica institucional"
groupStruct = "2. Swings / BOS"
groupVisual = "3. Diseño visual"
groupFlow   = "4. Filtro flujo (BOS / CVD)"

atrLen       = input.int(14,"Longitud ATR",group=groupLogic,minval=1)
atrMinFactor = input.float(1.0,"Mínimo rango OB vs ATR (x ATR)",group=groupLogic,step=0.1,minval=0.0)
rangeRelax   = input.float(0.8,"Factor relajación rango OB",group=groupLogic,step=0.05,minval=0.1)
atrMaxFactor = input.float(0.0,"Máximo rango OB vs ATR (x ATR, 0 = sin límite)",group=groupLogic,step=0.1,minval=0.0)

volLen        = input.int(60,"Lookback volumen institucional (barras)",group=groupLogic,minval=10)
volPercThresh = input.float(65.0,"Percentil volumen institucional (0–100)",group=groupLogic,step=1.0,minval=0.0,maxval=100.0)
maxBarsObToBos = input.int(20,"Máx barras entre OB y BOS",group=groupLogic,minval=1,maxval=200)

// Swings / BOS
swLen      = input.int(3,"Swing length BOS",group=groupStruct,minval=1)
dispFactor = input.float(0.3,"Desplazamiento mínimo tras BOS (x ATR)",group=groupStruct,step=0.05,minval=0.0)

// Proyección y gestión
projectionBars  = input.int(40,"Barras de proyección hacia adelante",group=groupStruct,minval=0,maxval=300)
maxOBs          = input.int(160,"Máx. OB almacenados",group=groupStruct,minval=20,maxval=200)
maxBarsHistory  = input.int(4500,"Máx barras históricas por OB (limitación TV)",group=groupStruct,minval=500,maxval=5000)

// Diseño
obBullColorInput   = input.color(color.new(#008929,0),"Color OB demanda",group=groupVisual)
obBullTranspInput  = input.int(80,"Transp. OB demanda (0–100)",group=groupVisual,minval=0,maxval=100)
obBearColorInput   = input.color(color.new(#5e0303,0),"Color OB oferta",group=groupVisual)
obBearTranspInput  = input.int(80,"Transp. OB oferta (0–100)",group=groupVisual,minval=0,maxval=100)
maxVisiblePerSide  = input.int(6,"Máx OB visibles por lado (cerca del precio)",group=groupVisual,minval=1,maxval=20)

// Filtro flujo en BOS – ahora basado en CVD institucional
useDeltaFilter = input.bool(false,"Requerir CVD a favor en vela BOS",group=groupFlow)
useSesionRTH   = input.bool(true,"Reset CVD por sesión RTH",group=groupFlow)
sesionRTH      = input.session("0930-1600","Horario RTH CVD",group=groupFlow)

//----------------------------------------------------
// 1.b PARÁMETROS EFECTIVOS SEGÚN PRESET
//----------------------------------------------------
int   atrLenEff       = atrLen
float atrMinEff       = atrMinFactor
float rangeRelaxEff   = rangeRelax
float atrMaxEff       = atrMaxFactor
int   volLenEff       = volLen
float volPercEff      = volPercThresh
int   swLenEff        = swLen
float dispEff         = dispFactor
int   maxBarsObToBosEff = maxBarsObToBos

string root = syminfo.root

if presetMode == "Futuros índice"
    atrLenEff       := 14
    atrMinEff       := 1.1
    rangeRelaxEff   := 0.8
    atrMaxEff       := 3.0
    volLenEff       := 80
    volPercEff      := 75.0
    swLenEff        := 3
    dispEff         := 0.35
    maxBarsObToBosEff := 25
else if presetMode == "ETF índice"
    atrLenEff       := 14
    atrMinEff       := 1.0
    rangeRelaxEff   := 0.8
    atrMaxEff       := 3.0
    volLenEff       := 70
    volPercEff      := 70.0
    swLenEff        := 3
    dispEff         := 0.30
    maxBarsObToBosEff := 25
else if presetMode == "MegaCap"
    atrLenEff       := 14
    atrMinEff       := 1.1
    rangeRelaxEff   := 0.8
    atrMaxEff       := 3.5
    volLenEff       := 90
    volPercEff      := 80.0
    swLenEff        := 3
    dispEff         := 0.35
    maxBarsObToBosEff := 25
else if presetMode == "Acción normal"
    atrLenEff       := 20
    atrMinEff       := 0.9
    rangeRelaxEff   := 0.85
    atrMaxEff       := 3.5
    volLenEff       := 80
    volPercEff      := 65.0
    swLenEff        := 4
    dispEff         := 0.30
    maxBarsObToBosEff := 30
else if presetMode == "Acción volátil"
    atrLenEff       := 20
    atrMinEff       := 0.8
    rangeRelaxEff   := 0.9
    atrMaxEff       := 4.0
    volLenEff       := 100
    volPercEff      := 70.0
    swLenEff        := 4
    dispEff         := 0.35
    maxBarsObToBosEff := 30
else if presetMode == "FX / Crypto"
    atrLenEff       := 14
    atrMinEff       := 0.9
    rangeRelaxEff   := 0.85
    atrMaxEff       := 3.5
    volLenEff       := 80
    volPercEff      := 70.0
    swLenEff        := 4
    dispEff         := 0.30
    maxBarsObToBosEff := 30
else if presetMode == "Auto por activo"
    if syminfo.type == "futures"
        atrLenEff       := 14
        atrMinEff       := 1.1
        rangeRelaxEff   := 0.8
        atrMaxEff       := 3.0
        volLenEff       := 80
        volPercEff      := 75.0
        swLenEff        := 3
        dispEff         := 0.35
        maxBarsObToBosEff := 25
    else if syminfo.type == "stock" and (root == "SPY" or root == "QQQ" or root == "IWM")
        atrLenEff       := 14
        atrMinEff       := 1.0
        rangeRelaxEff   := 0.8
        atrMaxEff       := 3.0
        volLenEff       := 70
        volPercEff      := 70.0
        swLenEff        := 3
        dispEff         := 0.30
        maxBarsObToBosEff := 25
    else if syminfo.type == "stock" and (root == "AAPL" or root == "MSFT" or root == "NVDA" or root == "TSLA" or root == "META" or root == "AMZN" or root == "GOOGL")
        atrLenEff       := 14
        atrMinEff       := 1.1
        rangeRelaxEff   := 0.8
        atrMaxEff       := 3.5
        volLenEff       := 90
        volPercEff      := 80.0
        swLenEff        := 3
        dispEff         := 0.35
        maxBarsObToBosEff := 25
    else if syminfo.type == "crypto"
        atrLenEff       := 14
        atrMinEff       := 0.9
        rangeRelaxEff   := 0.85
        atrMaxEff       := 3.5
        volLenEff       := 80
        volPercEff      := 70.0
        swLenEff        := 4
        dispEff         := 0.30
        maxBarsObToBosEff := 30
    else
        atrLenEff       := 20
        atrMinEff       := 0.9
        rangeRelaxEff   := 0.85
        atrMaxEff       := 3.5
        volLenEff       := 80
        volPercEff      := 65.0
        swLenEff        := 4
        dispEff         := 0.30
        maxBarsObToBosEff := 30

//----------------------------------------------------
// 2. CÁLCULOS BASE ATR Y VOLUMEN
//----------------------------------------------------
atrValue   = ta.atr(atrLenEff)
rangeSize  = high - low
volThresh  = ta.percentile_linear_interpolation(volume,volLenEff,volPercEff)
volInst    = volume >= volThresh

//----------------------------------------------------
// 2.b CVD INSTITUCIONAL (MISMA LÓGICA QUE TU MÓDULO)
//----------------------------------------------------
var float cvd = na

int   tRTH      = time(timeframe.period,sesionRTH)
bool  inRTH     = not na(tRTH)
bool  inicioRTH = inRTH and (na(tRTH[1]) or tRTH < tRTH[1])

bool  hasPrevClose = not na(close[1])
float deltaBarRaw  = hasPrevClose ? (close > close[1] ? volume : close < close[1] ? -volume : 0.0) : 0.0
float deltaBar     = useSesionRTH ? (inRTH ? deltaBarRaw : 0.0) : deltaBarRaw

bool  cambioDia = dayofmonth != dayofmonth[1]
bool  condReset = useSesionRTH ? inicioRTH : cambioDia

cvd := condReset or na(cvd[1]) ? deltaBar : cvd[1] + deltaBar

//----------------------------------------------------
// 3. SWINGS, BOS Y CHOCH INSTITUCIONAL
//----------------------------------------------------
var float lastSwingHigh = na
var float lastSwingLow  = na
var int   trendDir      = 0

ph = ta.pivothigh(high,swLenEff,swLenEff)
pl = ta.pivotlow(low,swLenEff,swLenEff)

if not na(ph)
    lastSwingHigh := ph
if not na(pl)
    lastSwingLow := pl

rawBosUp   = not na(lastSwingHigh) and close > lastSwingHigh
rawBosDown = not na(lastSwingLow) and close < lastSwingLow

dispUp   = rawBosUp   and (close - lastSwingHigh) >= atrValue * dispEff
dispDown = rawBosDown and (lastSwingLow - close) >= atrValue * dispEff

bosUp   = dispUp
bosDown = dispDown

int  prevTrend  = trendDir
bool chochUp    = bosUp   and prevTrend == -1
bool chochDown  = bosDown and prevTrend == 1

if bosUp
    trendDir := 1
if bosDown
    trendDir := -1

//----------------------------------------------------
// 4. CANDIDATOS A OB (VELA BASE)
//----------------------------------------------------
isBearCandle = close < open
isBullCandle = close > open

rangeOk = rangeSize >= atrMinEff * atrValue * rangeRelaxEff
if atrMaxEff > 0.0
    rangeOk := rangeOk and rangeSize <= atrMaxEff * atrValue

volumeOk = volInst

bullObCandidate = isBearCandle and rangeOk and volumeOk
bearObCandidate = isBullCandle and rangeOk and volumeOk

var bool  hasPendingBull = false
var float pendBullHigh   = na
var float pendBullLow    = na
var float pendBullVol    = na
var int   pendBullBar    = na

var bool  hasPendingBear = false
var float pendBearHigh   = na
var float pendBearLow    = na
var float pendBearVol    = na
var int   pendBearBar    = na

if bullObCandidate
    hasPendingBull := true
    pendBullHigh   := high
    pendBullLow    := low
    pendBullVol    := volume
    pendBullBar    := bar_index

if bearObCandidate
    hasPendingBear := true
    pendBearHigh   := high
    pendBearLow    := low
    pendBearVol    := volume
    pendBearBar    := bar_index

//----------------------------------------------------
// 5. ARRAYS DE OB
//----------------------------------------------------
var float[] obTopArr        = array.new_float()
var float[] obBottomArr     = array.new_float()
var float[] obMidArr        = array.new_float()
var bool[]  obIsBullArr     = array.new_bool()
var int[]   obStartIndexArr = array.new_int()
var int[]   obRightIndexArr = array.new_int()
var int[]   obCreateBarArr  = array.new_int()
var int[]   obTypeArr       = array.new_int()   // 1 = continuidad, 2 = reversal
var box[]   obBoxArr        = array.new_box()
var line[]  obLineArr       = array.new_line()
var label[] obLabelArr      = array.new_label()

//----------------------------------------------------
// 6. HELPERS
//----------------------------------------------------
f_deleteIndex(_i)=>
    box   b  = array.get(obBoxArr,_i)
    line  ln = array.get(obLineArr,_i)
    label lb = array.get(obLabelArr,_i)
    if not na(b)
        box.delete(b)
    if not na(ln)
        line.delete(ln)
    if not na(lb)
        label.delete(lb)
    array.remove(obBoxArr,_i)
    array.remove(obLineArr,_i)
    array.remove(obLabelArr,_i)
    array.remove(obTopArr,_i)
    array.remove(obBottomArr,_i)
    array.remove(obMidArr,_i)
    array.remove(obIsBullArr,_i)
    array.remove(obStartIndexArr,_i)
    array.remove(obRightIndexArr,_i)
    array.remove(obCreateBarArr,_i)
    array.remove(obTypeArr,_i)

f_createOb(isBull,top,bottom,startIndex,createBar,isReversal)=>
    float mid       = (top + bottom) * 0.5
    int   rightIdx  = bar_index + projectionBars
    color baseCol   = isBull ? obBullColorInput : obBearColorInput
    int   baseT     = isBull ? obBullTranspInput : obBearTranspInput
    int   obType    = isReversal ? 2 : 1
    box   b         = box.new(startIndex,top,rightIdx,bottom,xloc=xloc.bar_index,border_color=baseCol,bgcolor=color.new(baseCol,baseT))
    line  ln        = line.new(startIndex,mid,rightIdx,mid,xloc=xloc.bar_index,color=baseCol,style=line.style_dotted,width=1)
    int   labelX    = math.max(startIndex,rightIdx - 1)
    string txt      = isBull ? "OB+" : "OB-"
    if isReversal
        txt += "R"
    label lb        = label.new(labelX,mid,txt,textcolor=color.white,style=label.style_none,size=size.small,xloc=xloc.bar_index)
    float off       = (top - bottom) * 0.03
    label.set_y(lb,mid + off)
    label.set_yloc(lb,yloc.price)
    array.push(obTopArr,top)
    array.push(obBottomArr,bottom)
    array.push(obMidArr,mid)
    array.push(obIsBullArr,isBull)
    array.push(obStartIndexArr,startIndex)
    array.push(obRightIndexArr,rightIdx)
    array.push(obCreateBarArr,createBar)
    array.push(obTypeArr,obType)
    array.push(obBoxArr,b)
    array.push(obLineArr,ln)
    array.push(obLabelArr,lb)
    if array.size(obTopArr) > maxOBs
        f_deleteIndex(0)

f_isInIntArray(arr,val)=>
    bool found = false
    int szA    = array.size(arr)
    if szA > 0
        for ii = 0 to szA - 1
            if array.get(arr,ii) == val
                found := true
                break
    found

//----------------------------------------------------
// 7. CREACIÓN DE OB A PARTIR DE BOS (USANDO CVD)
//----------------------------------------------------
if bosUp and hasPendingBull
    int   ageBull      = bar_index - pendBullBar
    bool  ageOkBull    = ageBull <= maxBarsObToBosEff
    float bosBody      = close - open
    float bosRange     = math.max(high - low,syminfo.mintick)
    float bosDelta     = bosRange > 0.0 ? bosBody / bosRange * volume : 0.0
    bool  bosDeltaOk   = not useDeltaFilter or deltaBar > 0.0
    if ageOkBull and bosDeltaOk
        bool isRevBull = chochUp
        f_createOb(true,pendBullHigh,pendBullLow,pendBullBar,pendBullBar,isRevBull)
    hasPendingBull := false

if bosDown and hasPendingBear
    int   ageBear      = bar_index - pendBearBar
    bool  ageOkBear    = ageBear <= maxBarsObToBosEff
    float bosBody2     = close - open
    float bosRange2    = math.max(high - low,syminfo.mintick)
    float bosDelta2    = bosRange2 > 0.0 ? bosBody2 / bosRange2 * volume : 0.0
    bool  bosDeltaOk2  = not useDeltaFilter or deltaBar < 0.0
    if ageOkBear and bosDeltaOk2
        bool isRevBear = chochDown
        f_createOb(false,pendBearHigh,pendBearLow,pendBearBar,pendBearBar,isRevBear)
    hasPendingBear := false

//----------------------------------------------------
// 8. LIMPIEZA (MITIGACIÓN / HISTÓRICO)
//----------------------------------------------------
int sz = array.size(obTopArr)
if sz > 0
    for n = 0 to sz - 1
        int   i         = sz - 1 - n
        float top       = array.get(obTopArr,i)
        float bottom    = array.get(obBottomArr,i)
        int   createBar = array.get(obCreateBarArr,i)
        int   ageBars   = bar_index - createBar
        bool  tooOld    = ageBars > maxBarsHistory
        bool  overlaps  = high >= bottom and low <= top
        bool  fullMit   = overlaps and close <= top and close >= bottom
        if fullMit or tooOld
            f_deleteIndex(i)

//----------------------------------------------------
// 9. VISIBILIDAD – SÓLO N OB POR LADO CERCA DEL PRECIO
//----------------------------------------------------
int sz2 = array.size(obTopArr)
if sz2 > 0
    int[] bullVisibleIdx = array.new_int()
    int[] bearVisibleIdx = array.new_int()

    for n = 0 to maxVisiblePerSide - 1
        float bestDist = na
        int   bestIdx  = -1
        for i = 0 to sz2 - 1
            if array.get(obIsBullArr,i)
                bool already = f_isInIntArray(bullVisibleIdx,i)
                if not already
                    float d = math.abs(array.get(obMidArr,i) - close)
                    if na(bestDist) or d < bestDist
                        bestDist := d
                        bestIdx  := i
        if bestIdx != -1
            array.push(bullVisibleIdx,bestIdx)

    for n = 0 to maxVisiblePerSide - 1
        float bestDist2 = na
        int   bestIdx2  = -1
        for i = 0 to sz2 - 1
            if not array.get(obIsBullArr,i)
                bool already2 = f_isInIntArray(bearVisibleIdx,i)
                if not already2
                    float d2 = math.abs(array.get(obMidArr,i) - close)
                    if na(bestDist2) or d2 < bestDist2
                        bestDist2 := d2
                        bestIdx2  := i
        if bestIdx2 != -1
            array.push(bearVisibleIdx,bestIdx2)

    for i = 0 to sz2 - 1
        float top     = array.get(obTopArr,i)
        float bottom  = array.get(obBottomArr,i)
        float mid     = array.get(obMidArr,i)
        bool  isBull  = array.get(obIsBullArr,i)
        int   startIx = array.get(obStartIndexArr,i)
        box   b       = array.get(obBoxArr,i)
        line  ln      = array.get(obLineArr,i)
        label lb      = array.get(obLabelArr,i)
        int   obType  = array.size(obTypeArr) > i ? array.get(obTypeArr,i) : 1

        bool visible  = isBull ? f_isInIntArray(bullVisibleIdx,i) : f_isInIntArray(bearVisibleIdx,i)
        int  rightVis = bar_index + projectionBars
        array.set(obRightIndexArr,i,rightVis)

        color baseCol2 = isBull ? obBullColorInput : obBearColorInput
        int   baseT2   = isBull ? obBullTranspInput : obBearTranspInput
        color drawCol  = baseCol2
        int   drawT    = baseT2
        string txt2    = isBull ? "OB+" : "OB-"
        if obType == 2
            txt2 += "R"
        color labelCol = color.white

        if not visible
            drawT    := 100
            drawCol  := color.new(baseCol2,100)
            txt2     := ""
            labelCol := color.new(color.white,100)

        if not na(b)
            box.set_top(b,top)
            box.set_bottom(b,bottom)
            box.set_left(b,startIx)
            box.set_right(b,rightVis)
            box.set_border_color(b,drawCol)
            box.set_bgcolor(b,color.new(baseCol2,drawT))

        if na(ln)
            ln := line.new(startIx,mid,rightVis,mid,xloc=xloc.bar_index,color=drawCol,style=line.style_dotted,width=1)
            array.set(obLineArr,i,ln)
        if not na(ln)
            line.set_x1(ln,startIx)
            line.set_x2(ln,rightVis)
            line.set_y1(ln,mid)
            line.set_y2(ln,mid)
            line.set_color(ln,drawCol)
            line.set_style(ln,line.style_dotted)
            line.set_width(ln,1)

        int labelX2 = math.max(startIx,rightVis - 1)
        if na(lb)
            lb := label.new(labelX2,mid,txt2,textcolor=labelCol,style=label.style_none,size=size.small,xloc=xloc.bar_index)
            array.set(obLabelArr,i,lb)
        if not na(lb)
            label.set_text(lb,txt2)
            label.set_textcolor(lb,labelCol)
            label.set_x(lb,labelX2)
            float off2 = (top - bottom) * 0.03
            label.set_y(lb,mid + off2)
            label.set_yloc(lb,yloc.price)
