//@version=6
indicator("SMC – Breaker Institucional (Módulo Breaker)", overlay=true, max_boxes_count=200, max_lines_count=200, max_labels_count=200)

//----------------------------------------------------
// 1. INPUTS – LÓGICA OB INTERNA (NO SE DIBUJA)
//----------------------------------------------------
groupObLogic   = "1. Lógica OB interna (fuente Breaker)"
groupObStruct  = "2. Swings / BOS para OB"
groupBrkLogic  = "3. Lógica ruptura Breaker"
groupBrkMgmt   = "4. Gestión / vida útil"
groupBrkVisual = "5. Diseño visual Breaker"

// OB interno
atrLen       = input.int(14, "Longitud ATR", group=groupObLogic, minval=1)
atrMinFactor = input.float(1.0, "Mín. rango OB vs ATR (x ATR)", group=groupObLogic, step=0.1, minval=0.0)
rangeRelax   = input.float(0.8, "Factor relajación rango OB", group=groupObLogic, step=0.05, minval=0.1)
atrMaxFactor = input.float(0.0, "Máx. rango OB vs ATR (x ATR, 0 = sin límite)", group=groupObLogic, step=0.1, minval=0.0)

volLen         = input.int(60, "Lookback volumen institucional (barras)", group=groupObLogic, minval=10)
volPercThresh  = input.float(65.0, "Percentil volumen institucional (0–100)", group=groupObLogic, step=1.0, minval=0.0, maxval=100.0)
maxBarsObToBos = input.int(20, "Máx barras entre OB y BOS", group=groupObLogic, minval=1, maxval=200)
useDeltaOb     = input.bool(false, "Requerir flujo a favor en vela BOS (OB)", group=groupObLogic)

// Swings / BOS para OB
swLenOb      = input.int(3, "Swing length BOS (OB)", group=groupObStruct, minval=1)
dispFactorOb = input.float(0.3, "Desplazamiento mínimo BOS (OB) x ATR", group=groupObStruct, step=0.05, minval=0.0)

//----------------------------------------------------
// 2. INPUTS – LÓGICA BREAKER
//----------------------------------------------------
swLenBrk          = input.int(3, "Swing length BOS (Breaker)", group=groupBrkLogic, minval=1)
dispFactorBrk     = input.float(0.4, "Desplazamiento mínimo BOS (Breaker) x ATR", group=groupBrkLogic, step=0.05, minval=0.0)
maxBarsMitToBrk   = input.int(20, "Máx barras entre mitigación OB y BOS Breaker", group=groupBrkLogic, minval=1, maxval=200)
useDeltaBrk       = input.bool(true, "Requerir flujo a favor en vela BOS (Breaker)", group=groupBrkLogic)
requireInstVolBrk = input.bool(true, "Requerir volumen institucional en ruptura Breaker", group=groupBrkLogic)

// Gestión vida útil
projectionBarsBrk = input.int(120, "Barras de proyección Breaker", group=groupBrkMgmt, minval=0, maxval=500)
maxBreakers       = input.int(160, "Máx Breakers almacenados", group=groupBrkMgmt, minval=20, maxval=200)
maxBarsBrkHistory = input.int(4500, "Máx barras históricas por Breaker", group=groupBrkMgmt, minval=500, maxval=5000)
maxBarsObHistory  = input.int(4500, "Máx barras históricas OB interno", group=groupBrkMgmt, minval=500, maxval=5000)

//----------------------------------------------------
// 3. INPUTS – DISEÑO VISUAL BREAKER
//----------------------------------------------------
// Colores del Breaker
brkBullColorInput  = input.color(color.new(#1455FF, 0), "Color Breaker demanda (BRK+)", group=groupBrkVisual)
brkBullTranspInput = input.int(70, "Transp. Breaker demanda (0–100)", group=groupBrkVisual, minval=0, maxval=100)

brkBearColorInput  = input.color(color.new(#FF1414, 0), "Color Breaker oferta (BRK-)", group=groupBrkVisual)
brkBearTranspInput = input.int(70, "Transp. Breaker oferta (0–100)", group=groupBrkVisual, minval=0, maxval=100)

// Colores del OB original para el tramo histórico
obBullColorHistInput = input.color(color.new(#008929, 0), "Color histórico OB demanda", group=groupBrkVisual)
obBearColorHistInput = input.color(color.new(#5e0303, 0), "Color histórico OB oferta", group=groupBrkVisual)
obHistExtraTransp    = input.int(20, "Extra transparencia tramo OB histórico", group=groupBrkVisual, minval=0, maxval=60)

borderWidthInput   = input.int(1, "Grosor borde Breaker", group=groupBrkVisual, minval=1, maxval=5)
borderStyleOpt     = input.string("Solid", "Estilo borde", group=groupBrkVisual, options=["Solid", "Dashed", "Dotted"])
showCenterLine     = input.bool(true, "Mostrar línea central interna", group=groupBrkVisual)
centerLineWidth    = input.int(1, "Grosor línea central", group=groupBrkVisual, minval=1, maxval=3)
centerLineStyleOpt = input.string("Dotted", "Estilo línea central", group=groupBrkVisual, options=["Solid", "Dashed", "Dotted"])
showLabelInside    = input.bool(true, "Mostrar etiqueta 'BRK' dentro del bloque", group=groupBrkVisual)

//----------------------------------------------------
// 4. CÁLCULOS BASE ATR, VOLUMEN Y DELTA TICK
//----------------------------------------------------
atrValue  = ta.atr(atrLen)
rangeSize = high - low

volThresh = ta.percentile_linear_interpolation(volume, volLen, volPercThresh)
volInst   = volume >= volThresh

bool  hasPrevClose = not na(close[1])
float deltaTick    = hasPrevClose ? (close > close[1] ? volume : close < close[1] ? -volume : 0.0) : 0.0

//----------------------------------------------------
// 5. SWINGS / BOS – OB
//----------------------------------------------------
var float lastSwingHighOb = na
var float lastSwingLowOb  = na
var int   trendDirOb      = 0

phOb = ta.pivothigh(high, swLenOb, swLenOb)
plOb = ta.pivotlow(low, swLenOb, swLenOb)

if not na(phOb)
    lastSwingHighOb := phOb
if not na(plOb)
    lastSwingLowOb := plOb

rawBosUpOb   = not na(lastSwingHighOb) and close > lastSwingHighOb
rawBosDownOb = not na(lastSwingLowOb) and close < lastSwingLowOb

dispUpOb   = rawBosUpOb and (close - lastSwingHighOb) >= atrValue * dispFactorOb
dispDownOb = rawBosDownOb and (lastSwingLowOb - close) >= atrValue * dispFactorOb

bosUpOb   = dispUpOb
bosDownOb = dispDownOb

float bosDeltaOb = deltaTick

bosDeltaOkUpOb   = not useDeltaOb or bosDeltaOb > 0.0
bosDeltaOkDownOb = not useDeltaOb or bosDeltaOb < 0.0

int  prevTrendOb = trendDirOb
bool chochUpOb   = bosUpOb and prevTrendOb == -1
bool chochDownOb = bosDownOb and prevTrendOb == 1

if bosUpOb
    trendDirOb := 1
if bosDownOb
    trendDirOb := -1

//----------------------------------------------------
// 5B. SWINGS / BOS – BREAKER
//----------------------------------------------------
var float lastSwingHighBrk = na
var float lastSwingLowBrk  = na
var int   trendDirBrk      = 0

phBrk = ta.pivothigh(high, swLenBrk, swLenBrk)
plBrk = ta.pivotlow(low, swLenBrk, swLenBrk)

if not na(phBrk)
    lastSwingHighBrk := phBrk
if not na(plBrk)
    lastSwingLowBrk := plBrk

rawBosUpBrk   = not na(lastSwingHighBrk) and close > lastSwingHighBrk
rawBosDownBrk = not na(lastSwingLowBrk) and close < lastSwingLowBrk

dispUpBrk   = rawBosUpBrk and (close - lastSwingHighBrk) >= atrValue * dispFactorBrk
dispDownBrk = rawBosDownBrk and (lastSwingLowBrk - close) >= atrValue * dispFactorBrk

bosUpBrk   = dispUpBrk
bosDownBrk = dispDownBrk

float bosDeltaBrk = deltaTick

bosDeltaOkUpBrk   = not useDeltaBrk or bosDeltaBrk > 0.0
bosDeltaOkDownBrk = not useDeltaBrk or bosDeltaBrk < 0.0

int prevTrendBrk = trendDirBrk
if bosUpBrk
    trendDirBrk := 1
if bosDownBrk
    trendDirBrk := -1

//----------------------------------------------------
// 6. CANDIDATOS A OB INTERNO
//----------------------------------------------------
isBearCandle = close < open
isBullCandle = close > open

rangeOk = rangeSize >= atrMinFactor * atrValue * rangeRelax
if atrMaxFactor > 0.0
    rangeOk := rangeOk and rangeSize <= atrMaxFactor * atrValue

volumeOk = volInst

bullObCandidate = isBearCandle and rangeOk and volumeOk
bearObCandidate = isBullCandle and rangeOk and volumeOk

var bool  hasPendingBull = false
var float pendBullHigh   = na
var float pendBullLow    = na
var int   pendBullBar    = na

var bool  hasPendingBear = false
var float pendBearHigh   = na
var float pendBearLow    = na
var int   pendBearBar    = na

if bullObCandidate
    hasPendingBull := true
    pendBullHigh   := high
    pendBullLow    := low
    pendBullBar    := bar_index

if bearObCandidate
    hasPendingBear := true
    pendBearHigh   := high
    pendBearLow    := low
    pendBearBar    := bar_index

//----------------------------------------------------
// 7. ARRAYS OB INTERNOS (NO DIBUJADOS)
//----------------------------------------------------
var float[] obTopArr        = array.new_float()
var float[] obBottomArr     = array.new_float()
var bool[]  obIsBullArr     = array.new_bool()
var int[]   obStartIndexArr = array.new_int()
var int[]   obCreateBarArr  = array.new_int()
var int[]   obStateArr      = array.new_int()  // 0 = activo, 1 = mitigado esperando BOS, 2 = archivado

//----------------------------------------------------
// 8. ARRAYS BREAKER (VISIBLES)
//----------------------------------------------------
var float[] brkTopArr          = array.new_float()
var float[] brkBottomArr       = array.new_float()
var float[] brkMidArr          = array.new_float()
var bool[]  brkIsBullArr       = array.new_bool()
var int[]   brkStartIndexArr   = array.new_int()
var int[]   brkRightIndexArr   = array.new_int()
var int[]   brkCreateBarArr    = array.new_int()
var int[]   brkObStartIndexArr = array.new_int()
var box[]   brkBoxArr          = array.new_box()
var line[]  brkLineArr         = array.new_line()
var label[] brkLabelArr        = array.new_label()
var box[]   brkHistBoxArr      = array.new_box()

// Candidato a Breaker tras mitigación
var int brkCandidateObIndex = na
var int brkCandidateBar     = na

//----------------------------------------------------
// 9. HELPERS
//----------------------------------------------------
f_borderStyle(_opt)=>
    line_style = line.style_solid
    if _opt == "Dashed"
        line_style := line.style_dashed
    if _opt == "Dotted"
        line_style := line.style_dotted
    line_style

f_deleteBreakerIndex(_i)=>
    box   b  = array.get(brkBoxArr, _i)
    line  ln = array.get(brkLineArr, _i)
    label lb = array.get(brkLabelArr, _i)
    box   hb = array.get(brkHistBoxArr, _i)
    if not na(b)
        box.delete(b)
    if not na(ln)
        line.delete(ln)
    if not na(lb)
        label.delete(lb)
    if not na(hb)
        box.delete(hb)
    array.remove(brkBoxArr, _i)
    array.remove(brkLineArr, _i)
    array.remove(brkLabelArr, _i)
    array.remove(brkHistBoxArr, _i)
    array.remove(brkTopArr, _i)
    array.remove(brkBottomArr, _i)
    array.remove(brkMidArr, _i)
    array.remove(brkIsBullArr, _i)
    array.remove(brkStartIndexArr, _i)
    array.remove(brkRightIndexArr, _i)
    array.remove(brkCreateBarArr, _i)
    array.remove(brkObStartIndexArr, _i)

f_deleteObIndex(_i)=>
    array.remove(obTopArr, _i)
    array.remove(obBottomArr, _i)
    array.remove(obIsBullArr, _i)
    array.remove(obStartIndexArr, _i)
    array.remove(obCreateBarArr, _i)
    array.remove(obStateArr, _i)

// _isBull = tipo de Breaker, _obStartIndex = bar_index donde nació el OB
f_createBreaker(_isBull, _top, _bottom, _startIndex, _createBar, _obStartIndex)=>
    float mid      = (_top + _bottom) * 0.5
    int   rightIdx = bar_index + projectionBarsBrk

    color brkCol   = _isBull ? brkBullColorInput : brkBearColorInput
    int   brkT     = _isBull ? brkBullTranspInput : brkBearTranspInput

    color obCol    = _isBull ? obBearColorHistInput : obBullColorHistInput
    int   baseObT  = _isBull ? brkBearTranspInput : brkBullTranspInput
    int   obT      = math.min(baseObT + obHistExtraTransp, 100)

    line_style_border = f_borderStyle(borderStyleOpt)
    line_style_center = f_borderStyle(centerLineStyleOpt)

    box b = box.new(_startIndex, _top, rightIdx, _bottom, xloc=xloc.bar_index, border_color=brkCol, border_width=borderWidthInput, bgcolor=color.new(brkCol, brkT))
    line ln = na
    if showCenterLine
        ln := line.new(_startIndex, mid, rightIdx, mid, xloc=xloc.bar_index, color=brkCol, style=line_style_center, width=centerLineWidth)

    box hb = box.new(_obStartIndex, _top, _startIndex, _bottom, xloc=xloc.bar_index, border_color=color.new(obCol, 90), bgcolor=color.new(obCol, obT))

    int labelX = rightIdx - 1
    string txt = _isBull ? "BRK+" : "BRK-"
    label lb = na
    if showLabelInside
        lb := label.new(labelX, mid, txt, xloc=xloc.bar_index, yloc=yloc.price, textcolor=color.white, style=label.style_none, size=size.small)
        float off = (_top - _bottom) * 0.03
        label.set_y(lb, mid + off)

    array.push(brkTopArr, _top)
    array.push(brkBottomArr, _bottom)
    array.push(brkMidArr, mid)
    array.push(brkIsBullArr, _isBull)
    array.push(brkStartIndexArr, _startIndex)
    array.push(brkRightIndexArr, rightIdx)
    array.push(brkCreateBarArr, _createBar)
    array.push(brkObStartIndexArr, _obStartIndex)
    array.push(brkBoxArr, b)
    array.push(brkLineArr, ln)
    array.push(brkLabelArr, lb)
    array.push(brkHistBoxArr, hb)

    int szBrk = array.size(brkTopArr)
    if szBrk > maxBreakers
        f_deleteBreakerIndex(0)

//----------------------------------------------------
// 10. CREACIÓN OB INTERNO A PARTIR DE BOS
//----------------------------------------------------
if bosUpOb and hasPendingBull
    int ageBull = bar_index - pendBullBar
    bool ageOkBull = ageBull <= maxBarsObToBos
    if ageOkBull and bosDeltaOkUpOb
        bool isBull = true
        array.push(obTopArr, pendBullHigh)
        array.push(obBottomArr, pendBullLow)
        array.push(obIsBullArr, isBull)
        array.push(obStartIndexArr, pendBullBar)
        array.push(obCreateBarArr, pendBullBar)
        array.push(obStateArr, 0)
    hasPendingBull := false

if bosDownOb and hasPendingBear
    int ageBear = bar_index - pendBearBar
    bool ageOkBear = ageBear <= maxBarsObToBos
    if ageOkBear and bosDeltaOkDownOb
        bool isBull2 = false
        array.push(obTopArr, pendBearHigh)
        array.push(obBottomArr, pendBearLow)
        array.push(obIsBullArr, isBull2)
        array.push(obStartIndexArr, pendBearBar)
        array.push(obCreateBarArr, pendBearBar)
        array.push(obStateArr, 0)
    hasPendingBear := false

//----------------------------------------------------
// 11. GESTIÓN OB INTERNO: MITIGACIÓN Y CADUCIDAD
//----------------------------------------------------
int szOb = array.size(obTopArr)
if szOb > 0
    int iOb = szOb - 1
    while iOb >= 0
        float top       = array.get(obTopArr, iOb)
        float bottom    = array.get(obBottomArr, iOb)
        int   createBar = array.get(obCreateBarArr, iOb)
        int   ageBars   = bar_index - createBar
        int   stateOb   = array.get(obStateArr, iOb)

        bool tooOldOb = ageBars > maxBarsObHistory
        bool overlaps = high >= bottom and low <= top
        bool fullMit  = overlaps and close <= top and close >= bottom

        if tooOldOb or stateOb == 2
            f_deleteObIndex(iOb)
        else
            if stateOb == 0 and fullMit
                array.set(obStateArr, iOb, 1)
                brkCandidateObIndex := iOb
                brkCandidateBar := bar_index
        iOb -= 1

//----------------------------------------------------
// 12. RUPTURA INSTITUCIONAL – CREACIÓN BREAKER
//----------------------------------------------------
bool canCreateBrk = not na(brkCandidateObIndex)
if canCreateBrk
    int idx = brkCandidateObIndex
    if idx >= 0 and idx < array.size(obTopArr)
        float topOb        = array.get(obTopArr, idx)
        float bottomOb     = array.get(obBottomArr, idx)
        bool  isBullOb     = array.get(obIsBullArr, idx)
        int   obStartIndex = array.get(obStartIndexArr, idx)
        int   ageMit       = bar_index - brkCandidateBar
        bool  ageOk        = ageMit <= maxBarsMitToBrk

        bool bosOpposite = false
        bool deltaOkBrk  = true
        if isBullOb
            bosOpposite := bosDownBrk
            deltaOkBrk  := bosDeltaOkDownBrk
        else
            bosOpposite := bosUpBrk
            deltaOkBrk  := bosDeltaOkUpBrk

        bool volOkBrk = not requireInstVolBrk or volInst

        if ageOk and bosOpposite and deltaOkBrk and volOkBrk
            bool brkIsBull = not isBullOb
            int startIndexBrk = bar_index
            f_createBreaker(brkIsBull, topOb, bottomOb, startIndexBrk, bar_index, obStartIndex)
            array.set(obStateArr, idx, 2)
            brkCandidateObIndex := na
            brkCandidateBar := na

//----------------------------------------------------
// 13. GESTIÓN BREAKER: EXTENSIÓN E INVALIDACIÓN
//----------------------------------------------------
int szBrk2 = array.size(brkTopArr)
if szBrk2 > 0
    line_style_border2 = f_borderStyle(borderStyleOpt)
    line_style_center2 = f_borderStyle(centerLineStyleOpt)

    int iBrk = szBrk2 - 1
    while iBrk >= 0
        float topBrk        = array.get(brkTopArr, iBrk)
        float bottomBrk     = array.get(brkBottomArr, iBrk)
        float midBrk        = array.get(brkMidArr, iBrk)
        bool  isBullBrk     = array.get(brkIsBullArr, iBrk)
        int   startIx       = array.get(brkStartIndexArr, iBrk)
        int   createBarBrk  = array.get(brkCreateBarArr, iBrk)
        int   obStartIxBrk  = array.get(brkObStartIndexArr, iBrk)

        int ageBrk = bar_index - createBarBrk
        bool tooOldBrk = ageBrk > maxBarsBrkHistory

        bool overlapsBrk = high >= bottomBrk and low <= topBrk
        bool fullMitBrk  = overlapsBrk and close <= topBrk and close >= bottomBrk

        if tooOldBrk or fullMitBrk
            f_deleteBreakerIndex(iBrk)
        else
            int rightIdx2 = bar_index + projectionBarsBrk
            array.set(brkRightIndexArr, iBrk, rightIdx2)

            box b2   = array.get(brkBoxArr, iBrk)
            line ln2 = array.get(brkLineArr, iBrk)
            label lb2= array.get(brkLabelArr, iBrk)
            box hb2  = array.get(brkHistBoxArr, iBrk)

            color brkCol2 = isBullBrk ? brkBullColorInput : brkBearColorInput
            int   brkT2   = isBullBrk ? brkBullTranspInput : brkBearTranspInput

            color obCol2  = isBullBrk ? obBearColorHistInput : obBullColorHistInput
            int   baseObT2= isBullBrk ? brkBearTranspInput : brkBullTranspInput
            int   obT2    = math.min(baseObT2 + obHistExtraTransp, 100)

            if not na(b2)
                box.set_top(b2, topBrk)
                box.set_bottom(b2, bottomBrk)
                box.set_left(b2, startIx)
                box.set_right(b2, rightIdx2)
                box.set_border_color(b2, brkCol2)
                box.set_border_width(b2, borderWidthInput)
                box.set_bgcolor(b2, color.new(brkCol2, brkT2))

            if not na(hb2)
                box.set_top(hb2, topBrk)
                box.set_bottom(hb2, bottomBrk)
                box.set_left(hb2, obStartIxBrk)
                box.set_right(hb2, startIx)
                box.set_border_color(hb2, color.new(obCol2, 90))
                box.set_bgcolor(hb2, color.new(obCol2, obT2))

            if showCenterLine
                if na(ln2)
                    ln2 := line.new(startIx, midBrk, rightIdx2, midBrk, xloc=xloc.bar_index, color=brkCol2, style=line_style_center2, width=centerLineWidth)
                    array.set(brkLineArr, iBrk, ln2)
                if not na(ln2)
                    line.set_x1(ln2, startIx)
                    line.set_x2(ln2, rightIdx2)
                    line.set_y1(ln2, midBrk)
                    line.set_y2(ln2, midBrk)
                    line.set_color(ln2, brkCol2)
                    line.set_style(ln2, line_style_center2)
                    line.set_width(ln2, centerLineWidth)
            else
                if not na(ln2)
                    line.delete(ln2)
                    array.set(brkLineArr, iBrk, na)

            if showLabelInside
                int labelX2 = rightIdx2 - 1
                string txt2 = isBullBrk ? "BRK+" : "BRK-"
                if na(lb2)
                    lb2 := label.new(labelX2, midBrk, txt2, xloc=xloc.bar_index, yloc=yloc.price, textcolor=color.white, style=label.style_none, size=size.small)
                    array.set(brkLabelArr, iBrk, lb2)
                if not na(lb2)
                    label.set_text(lb2, txt2)
                    label.set_textcolor(lb2, color.white)
                    label.set_x(lb2, labelX2)
                    float off2 = (topBrk - bottomBrk) * 0.03
                    label.set_y(lb2, midBrk + off2)
            else
                if not na(lb2)
                    label.delete(lb2)
                    array.set(brkLabelArr, iBrk, na)
        iBrk -= 1
