//@version=6
indicator("SMC – FVG Institucional (Módulo FVG)", overlay = true, max_boxes_count = 200, max_lines_count = 200, max_labels_count = 200)

//-------------------------------
// 0. PRESET INSTITUCIONAL
//-------------------------------
groupPreset = "0. Preset institucional"
presetMode  = input.string("Auto por activo", "Preset institucional",
     options = ["Personalizado","Futuros","ETF índice","MegaCap","MidCap","Auto por activo"],
     group = groupPreset)

//-------------------------------
// 1. INPUTS – LÓGICA INSTITUCIONAL
//-------------------------------
groupLogic   = "1. Lógica institucional"
atrLen       = input.int(14, "Longitud ATR", minval = 1, group = groupLogic)
atrMinFactor = input.float(0.6, "Mínimo gap vs ATR", step = 0.1, group = groupLogic)
bodyLen      = input.int(20, "Lookback tamaño cuerpo", minval = 1, group = groupLogic)
dispFactor   = input.float(1.2, "Mínimo factor desplazamiento (cuerpo ×)", step = 0.1, group = groupLogic)

//-------------------------------
// 2. INPUTS – VOLUMEN AGRESIVO
//-------------------------------
groupVolume = "2. Volumen agresivo"
volLen      = input.int(60, "Lookback volumen", minval = 5, group = groupVolume)
volFactor   = input.float(1.4, "Factor volumen vs media", step = 0.1, group = groupVolume)

//-------------------------------
// 3. INPUTS – CONTEXTO TENDENCIA
//-------------------------------
groupTrend     = "3. Contexto tendencia"
emaLen         = input.int(50, "Longitud EMA filtro", minval = 1, group = groupTrend)
useTrendFilter = input.bool(true, "Usar filtro de tendencia (EMA)", group = groupTrend)

//-------------------------------
// 3.1 SESIONES / KILL ZONES (BONUS SCORE)
//-------------------------------
groupSessionFvg = "3.1 Sesiones / Kill zones (score)"
useSessionFvg   = input.bool(false, "Usar sesiones para bonus de score", group = groupSessionFvg)
session1Fvg     = input.session("0200-0500", "Sesión 1 (ej. London)", group = groupSessionFvg)
session2Fvg     = input.session("0830-1030", "Sesión 2 (ej. NY cash índices)", group = groupSessionFvg)
sessionBonusFvg = input.float(0.5, "Bonus de score si FVG nace en sesión", step = 0.1, minval = 0.0, maxval = 3.0, group = groupSessionFvg)

//-------------------------------
// 3.2 LIQUIDEZ DIARIA (PDH/PDL/PDC) – BONUS SCORE
//-------------------------------
groupLiqFvg        = "3.2 Liquidez diaria (score)"
useLiqDailyFvg     = input.bool(true, "Usar PDH/PDL/PDC en score", group = groupLiqFvg)
liqDistFactorFvg   = input.float(0.5, "Dist máx a PDH/PDL/PDC (x ATR)", step = 0.1, group = groupLiqFvg)
liqBonusFvg        = input.float(0.7, "Bonus base score si cerca de nivel diario", step = 0.1, minval = 0.0, maxval = 3.0, group = groupLiqFvg)

//-------------------------------
// 4. INPUTS – DISEÑO (ESTILO OB)
//-------------------------------
groupDraw         = "4. Diseño visual"
fvgBullColorInput = input.color(color.new(#00897b,0), "Color FVG demanda", group = groupDraw)
fvgBullTransp     = input.int(80, "Transp. FVG demanda (0–100)", minval = 0, maxval = 100, group = groupDraw)
fvgBearColorInput = input.color(color.new(#ff5252,0), "Color FVG oferta", group = groupDraw)
fvgBearTransp     = input.int(80, "Transp. FVG oferta (0–100)", minval = 0, maxval = 100, group = groupDraw)
maxVisiblePerSide = input.int(6, "Máx FVG visibles por lado (cerca del precio)", minval = 1, maxval = 20, group = groupDraw)

// estilos fijos tipo OB
bullBase   = fvgBullColorInput
bearBase   = fvgBearColorInput
bullColor  = color.new(bullBase, fvgBullTransp)
bearColor  = color.new(bearBase, fvgBearTransp)
bullBorder = bullBase
bearBorder = bearBase
midLineStyle = line.style_dotted
midLineWidth = 1
labelSize    = size.small
projectionBarsFVG = 30

//-------------------------------
// 5. INPUTS – MITIGACIÓN
//-------------------------------
groupMit        = "5. Mitigación"
showMitigated   = input.bool(false, "Mostrar FVG mitigados (si no, se borran)", group = groupMit)
mitigatedAlpha  = input.int(90, "Transp. mitigados (0–100)", minval = 0, maxval = 100, group = groupMit)
mitBullColor    = color.new(bullBase, mitigatedAlpha)
mitBearColor    = color.new(bearBase, mitigatedAlpha)
mitBorderColor  = input.color(color.new(color.gray,0), "Borde FVG mitigado", group = groupMit)
mitLineColor    = input.color(color.new(color.gray,0), "Línea central mitigada", group = groupMit)

//-------------------------------
// 6. INPUTS – SCORE Y FVG FUERTES
//-------------------------------
groupScore     = "6. Filtro FVG fuertes"
strongOnlyFVG  = input.bool(false, "Mostrar sólo FVG fuertes (score)", group = groupScore)
hideWeakFVG    = input.bool(true, "Ocultar FVG débiles (en vez de atenuar)", group = groupScore)
maxFvgVisible  = input.int(15, "Máx FVG fuertes visibles", minval = 1, maxval = 80, group = groupScore)
weakExtraAlpha = input.int(10, "Extra transparencia FVG débiles", minval = 0, maxval = 40, group = groupScore)
fadeBarsFVG    = input.int(600, "Barras para priorizar FVG recientes", minval = 50, maxval = 5000, group = groupScore)

//-------------------------------
// 7. INPUTS – CVD INSTITUCIONAL (FILTRO OPCIONAL)
//-------------------------------
groupCvd        = "7. CVD institucional (filtro FVG)"
useCvdFilterFvg = input.bool(false, "Usar filtro CVD en FVG", group = groupCvd)
useSesionRTHCvd = input.bool(true, "Reset CVD por sesión RTH", group = groupCvd)
sesionRTHCvd    = input.session("0930-1600", "Horario RTH CVD", group = groupCvd)
lenTrendCvd     = input.int(20, "Longitud tendencia (precio/CVD)", minval = 5, group = groupCvd)

//-------------------------------
// 8. FACTORES EFECTIVOS SEGÚN PRESET
//-------------------------------
float atrMinEff    = atrMinFactor
float dispEff      = dispFactor
float volFactorEff = volFactor

string root = syminfo.root

if presetMode=="Futuros"
    atrMinEff    := 0.7
    dispEff      := 1.5
    volFactorEff := 1.7
else if presetMode=="ETF índice"
    atrMinEff    := 0.6
    dispEff      := 1.3
    volFactorEff := 1.6
else if presetMode=="MegaCap"
    atrMinEff    := 0.5
    dispEff      := 1.25
    volFactorEff := 1.5
else if presetMode=="MidCap"
    atrMinEff    := 0.4
    dispEff      := 1.25
    volFactorEff := 1.4
else if presetMode=="Auto por activo"
    if syminfo.type=="futures"
        atrMinEff    := 0.7
        dispEff      := 1.5
        volFactorEff := 1.7
    else if root=="SPY" or root=="QQQ" or root=="IWM" or root=="DIA"
        atrMinEff    := 0.6
        dispEff      := 1.3
        volFactorEff := 1.6
    else if syminfo.type=="stock"
        atrMinEff    := 0.45
        dispEff      := 1.25
        volFactorEff := 1.4

//-------------------------------
// 9. CÁLCULOS BÁSICOS
//-------------------------------
atr     = ta.atr(atrLen)
body    = math.abs(close - open)
avgBody = ta.sma(body, bodyLen)

emaTrend = ta.ema(close, emaLen)
trendUp  = not useTrendFilter or close>emaTrend
trendDn  = not useTrendFilter or close<emaTrend

volMA       = ta.sma(volume, volLen)
highVolume1 = volume[1] >= volMA[1] * volFactorEff

body1          = math.abs(close[1] - open[1])
displacementUp = close[1]>open[1] and body1>=avgBody[1]*dispEff
displacementDn = close[1]<open[1] and body1>=avgBody[1]*dispEff

inSess1Fvg    = not na(time(timeframe.period, session1Fvg))
inSess2Fvg    = not na(time(timeframe.period, session2Fvg))
inMainSessFvg = inSess1Fvg or inSess2Fvg

// Liquidez diaria
pdh = request.security(syminfo.tickerid, "D", high[1])
pdl = request.security(syminfo.tickerid, "D", low[1])
pdc = request.security(syminfo.tickerid, "D", close[1])

//-------------------------------
// 10. CVD INSTITUCIONAL INTERNO (MISMA LÓGICA QUE TU INDICADOR)
//-------------------------------
int  tRTHCvd      = time(timeframe.period, sesionRTHCvd)
bool inRTHCvd     = not na(tRTHCvd)
bool inicioRTHCvd = inRTHCvd and (na(tRTHCvd[1]) or tRTHCvd < tRTHCvd[1])

var float cvd = na

bool  hasPrevClose = not na(close[1])
float deltaBarRaw  = hasPrevClose ? (close > close[1] ? volume : close < close[1] ? -volume : 0.0) : 0.0
float deltaBar     = useSesionRTHCvd ? (inRTHCvd ? deltaBarRaw : 0.0) : deltaBarRaw

bool cambioDiaCvd = dayofmonth != dayofmonth[1]
bool condResetCvd = useSesionRTHCvd ? inicioRTHCvd : cambioDiaCvd

cvd := condResetCvd or na(cvd[1]) ? deltaBar : cvd[1] + deltaBar

float prNowCvd      = ta.linreg(close, lenTrendCvd, 0)
float prPrevCvd     = ta.linreg(close, lenTrendCvd, 1)
float slopePriceCvd = prNowCvd - prPrevCvd

float cvdNow        = ta.linreg(cvd, lenTrendCvd, 0)
float cvdPrev       = ta.linreg(cvd, lenTrendCvd, 1)
float slopeCvd      = cvdNow - cvdPrev

bool upCvd   = slopeCvd > 0
bool downCvd = slopeCvd < 0

bool condBullCvd = not useCvdFilterFvg or (upCvd and slopePriceCvd >= 0)
bool condBearCvd = not useCvdFilterFvg or (downCvd and slopePriceCvd <= 0)

//-------------------------------
// 11. ARRAYS DE FVG
//-------------------------------
var box[]   bullBoxes      = array.new_box()
var line[]  bullLines      = array.new_line()
var label[] bullLabels     = array.new_label()
var float[] bullTops       = array.new_float()
var float[] bullBots       = array.new_float()
var bool[]  bullActive     = array.new_bool()
var float[] bullScores     = array.new_float()
var int[]   bullCreateBars = array.new_int()

var box[]   bearBoxes      = array.new_box()
var line[]  bearLines      = array.new_line()
var label[] bearLabels     = array.new_label()
var float[] bearTops       = array.new_float()
var float[] bearBots       = array.new_float()
var bool[]  bearActive     = array.new_bool()
var float[] bearScores     = array.new_float()
var int[]   bearCreateBars = array.new_int()

var float fvgScoreThreshold = 0.0

//-------------------------------
// 12. DETECCIÓN Y CREACIÓN DE FVG
//-------------------------------
if bar_index>=2
    // Bullish FVG
    bullGapTop    = low
    bullGapBottom = high[2]
    bullGapSize   = bullGapTop - bullGapBottom
    isBullGapRaw  = bullGapTop>bullGapBottom
    isBullFvgSize = bullGapSize>=atr[1]*atrMinEff
    isBullFVG     = isBullGapRaw and isBullFvgSize and displacementUp and highVolume1 and trendUp and condBullCvd

    if isBullFVG
        bTop = bullGapTop
        bBot = bullGapBottom
        mid  = (bTop + bBot)*0.5

        gapScore     = atr[1]>0?bullGapSize/atr[1]:0.0
        volScore     = volMA[1]>0?(volume[1]/volMA[1]) - 1.0:0.0
        dispScoreV   = avgBody[1]>0?body1/avgBody[1]:0.0
        sessionScore = useSessionFvg and inMainSessFvg?sessionBonusFvg:0.0

        liqMacroScoreBull = 0.0
        if useLiqDailyFvg and atr[1]>0
            distMax = atr[1] * liqDistFactorFvg
            nearPDL = math.abs(mid - pdl)<=distMax
            nearPDC = math.abs(mid - pdc)<=distMax
            if nearPDL or nearPDC
                liqMacroScoreBull := liqBonusFvg

        fvgScore = math.max(0.0, gapScore + math.max(volScore,0.0) + math.max(dispScoreV,0.0) + sessionScore + liqMacroScoreBull)

        rightVis = bar_index + projectionBarsFVG
        b = box.new(bar_index[2], bTop, rightVis, bBot, xloc = xloc.bar_index, bgcolor = bullColor, border_color = bullBorder)
        l = line.new(bar_index[2], mid, rightVis, mid, xloc = xloc.bar_index, style = midLineStyle, width = midLineWidth, color = bullBorder)

        offsetV = (bTop - bBot)*0.12
        labY    = mid + offsetV
        labX    = rightVis - 1
        lab     = label.new(labX, labY, "FVG+", style = label.style_none, textcolor = color.white, size = labelSize, xloc = xloc.bar_index, yloc = yloc.price)

        array.push(bullBoxes, b)
        array.push(bullLines, l)
        array.push(bullLabels, lab)
        array.push(bullTops, bTop)
        array.push(bullBots, bBot)
        array.push(bullActive, true)
        array.push(bullScores, fvgScore)
        array.push(bullCreateBars, bar_index)

    // Bearish FVG
    bearGapTop    = low[2]
    bearGapBottom = high
    bearGapSize   = bearGapTop - bearGapBottom
    isBearGapRaw  = bearGapTop>bearGapBottom
    isBearFvgSize = bearGapSize>=atr[1]*atrMinEff
    isBearFVG     = isBearGapRaw and isBearFvgSize and displacementDn and highVolume1 and trendDn and condBearCvd

    if isBearFVG
        bTop = bearGapTop
        bBot = bearGapBottom
        mid  = (bTop + bBot)*0.5

        gapScore     = atr[1]>0?bearGapSize/atr[1]:0.0
        volScore     = volMA[1]>0?(volume[1]/volMA[1]) - 1.0:0.0
        dispScoreV   = avgBody[1]>0?body1/avgBody[1]:0.0
        sessionScore = useSessionFvg and inMainSessFvg?sessionBonusFvg:0.0

        liqMacroScoreBear = 0.0
        if useLiqDailyFvg and atr[1]>0
            distMax = atr[1] * liqDistFactorFvg
            nearPDH = math.abs(mid - pdh)<=distMax
            nearPDC = math.abs(mid - pdc)<=distMax
            if nearPDH or nearPDC
                liqMacroScoreBear := liqBonusFvg

        fvgScore = math.max(0.0, gapScore + math.max(volScore,0.0) + math.max(dispScoreV,0.0) + sessionScore + liqMacroScoreBear)

        rightVis = bar_index + projectionBarsFVG
        b = box.new(bar_index[2], bTop, rightVis, bBot, xloc = xloc.bar_index, bgcolor = bearColor, border_color = bearBorder)
        l = line.new(bar_index[2], mid, rightVis, mid, xloc = xloc.bar_index, style = midLineStyle, width = midLineWidth, color = bearBorder)

        offsetV = (bTop - bBot)*0.12
        labY    = mid + offsetV
        labX    = rightVis - 1
        lab     = label.new(labX, labY, "FVG-", style = label.style_none, textcolor = color.white, size = labelSize, xloc = xloc.bar_index, yloc = yloc.price)

        array.push(bearBoxes, b)
        array.push(bearLines, l)
        array.push(bearLabels, lab)
        array.push(bearTops, bTop)
        array.push(bearBots, bBot)
        array.push(bearActive, true)
        array.push(bearScores, fvgScore)
        array.push(bearCreateBars, bar_index)

//-------------------------------
// 13. FUNCIÓN UMBRAL SCORE FVG FUERTES
//-------------------------------
calcStrongThreshold() =>
    float[] scores = array.new_float()
    for i = 0 to array.size(bullScores) - 1
        if array.get(bullActive, i)
            baseSc = array.get(bullScores, i)
            cBar   = array.get(bullCreateBars, i)
            age    = bar_index - cBar
            recB   = age>=fadeBarsFVG?0.0:(fadeBarsFVG - age)/fadeBarsFVG*0.5
            effSc  = baseSc * (1.0 + recB)
            array.push(scores, effSc)
    for i = 0 to array.size(bearScores) - 1
        if array.get(bearActive, i)
            baseSc = array.get(bearScores, i)
            cBar   = array.get(bearCreateBars, i)
            age    = bar_index - cBar
            recB   = age>=fadeBarsFVG?0.0:(fadeBarsFVG - age)/fadeBarsFVG*0.5
            effSc  = baseSc * (1.0 + recB)
            array.push(scores, effSc)
    sz = array.size(scores)
    if sz==0
        0.0
    else
        array.sort(scores, order.descending)
        keepIndex = math.min(maxFvgVisible - 1, sz - 1)
        array.get(scores, keepIndex)

hasAnyFvg = array.size(bullScores)>0 or array.size(bearScores)>0

if strongOnlyFVG and hasAnyFvg
    fvgScoreThreshold := calcStrongThreshold()
else
    fvgScoreThreshold := 0.0

//-------------------------------
// 14. UPDATE/MITIGACIÓN – FVG ALCISTAS
//-------------------------------
bullCount = array.size(bullBoxes)
if bullCount>0
    for i = 0 to bullCount - 1
        if array.get(bullActive, i)
            b   = array.get(bullBoxes, i)
            l   = array.get(bullLines, i)
            lab = array.get(bullLabels, i)
            t   = array.get(bullTops, i)
            bt  = array.get(bullBots, i)
            sc  = array.get(bullScores, i)

            box.set_bgcolor(b, bullColor)

            isStrong = not strongOnlyFVG or sc>=fvgScoreThreshold

            rightVis = bar_index + projectionBarsFVG
            box.set_right(b, rightVis)
            line.set_x2(l, rightVis)

            mid    = (t + bt)*0.5
            offset = (t - bt)*0.12
            labY   = mid + offset
            labX   = rightVis - 1
            label.set_x(lab, labX)
            label.set_y(lab, labY)

            if strongOnlyFVG and not isStrong
                if hideWeakFVG
                    box.set_bgcolor(b, color.new(bullBase,100))
                    box.set_border_color(b, color.new(bullBorder,100))
                    line.set_color(l, color.new(bullBorder,100))
                    label.set_text(lab, "")
                else
                    weakAlpha = math.min(100, fvgBullTransp + weakExtraAlpha)
                    box.set_bgcolor(b, color.new(bullBase, weakAlpha))
                    line.set_color(l, color.new(bullBorder,80))

            if low<=bt
                if showMitigated
                    box.set_bgcolor(b, mitBullColor)
                    box.set_border_color(b, mitBorderColor)
                    line.set_color(l, mitLineColor)
                    midMit = (t + bt)*0.5
                    line.set_y1(l, midMit)
                    line.set_y2(l, midMit)
                else
                    box.delete(b)
                    line.delete(l)
                    label.delete(lab)
                array.set(bullActive, i, false)

//-------------------------------
// 15. UPDATE/MITIGACIÓN – FVG BAJISTAS
//-------------------------------
bearCount = array.size(bearBoxes)
if bearCount>0
    for i = 0 to bearCount - 1
        if array.get(bearActive, i)
            b   = array.get(bearBoxes, i)
            l   = array.get(bearLines, i)
            lab = array.get(bearLabels, i)
            t   = array.get(bearTops, i)
            bt  = array.get(bearBots, i)
            sc  = array.get(bearScores, i)

            box.set_bgcolor(b, bearColor)

            isStrong = not strongOnlyFVG or sc>=fvgScoreThreshold

            rightVis = bar_index + projectionBarsFVG
            box.set_right(b, rightVis)
            line.set_x2(l, rightVis)

            mid    = (t + bt)*0.5
            offset = (t - bt)*0.12
            labY   = mid + offset
            labX   = rightVis - 1
            label.set_x(lab, labX)
            label.set_y(lab, labY)

            if strongOnlyFVG and not isStrong
                if hideWeakFVG
                    box.set_bgcolor(b, color.new(bearBase,100))
                    box.set_border_color(b, color.new(bearBorder,100))
                    line.set_color(l, color.new(bearBorder,100))
                    label.set_text(lab, "")
                else
                    weakAlpha = math.min(100, fvgBearTransp + weakExtraAlpha)
                    box.set_bgcolor(b, color.new(bearBase, weakAlpha))
                    line.set_color(l, color.new(bearBorder,80))

            if high>=t
                if showMitigated
                    box.set_bgcolor(b, mitBearColor)
                    box.set_border_color(b, mitBorderColor)
                    line.set_color(l, mitLineColor)
                    midMit = (t + bt)*0.5
                    line.set_y1(l, midMit)
                    line.set_y2(l, midMit)
                else
                    box.delete(b)
                    line.delete(l)
                    label.delete(lab)
                array.set(bearActive, i, false)

//-------------------------------
// 16. HELPER VISIBILIDAD
//-------------------------------
f_isInIntArray(arr, val) =>
    bool found = false
    int szA = array.size(arr)
    if szA>0
        for ii = 0 to szA - 1
            if array.get(arr, ii) == val
                found := true
                break
    found

//-------------------------------
// 17. VISIBILIDAD – SÓLO N FVG CERCA DEL PRECIO
//-------------------------------
bullCount2 = array.size(bullBoxes)
bearCount2 = array.size(bearBoxes)

// Alcistas
if bullCount2>0
    int[] bullVisibleIdx = array.new_int()

    for n = 0 to maxVisiblePerSide - 1
        float bestDist = na
        int bestIdx = -1
        for i = 0 to bullCount2 - 1
            if array.get(bullActive, i)
                bool already = f_isInIntArray(bullVisibleIdx, i)
                if not already
                    float mid = (array.get(bullTops, i) + array.get(bullBots, i)) * 0.5
                    float d = math.abs(mid - close)
                    if na(bestDist) or d < bestDist
                        bestDist := d
                        bestIdx := i
        if bestIdx != -1
            array.push(bullVisibleIdx, bestIdx)

    for i = 0 to bullCount2 - 1
        box b = array.get(bullBoxes, i)
        line l = array.get(bullLines, i)
        label lab = array.get(bullLabels, i)
        bool isActive = array.get(bullActive, i)
        bool visible = not isActive or f_isInIntArray(bullVisibleIdx, i)

        if not na(b)
            if isActive and not visible
                box.set_bgcolor(b, color.new(bullBase,100))
                box.set_border_color(b, color.new(bullBorder,100))
            else
                box.set_bgcolor(b, bullColor)
                box.set_border_color(b, bullBorder)
        if not na(l)
            if isActive and not visible
                line.set_color(l, color.new(bullBorder,100))
            else
                line.set_color(l, bullBorder)
        if not na(lab)
            if isActive and not visible
                label.set_text(lab, "")
            else
                label.set_text(lab, "FVG+")

// Bajistas
if bearCount2>0
    int[] bearVisibleIdx = array.new_int()

    for n = 0 to maxVisiblePerSide - 1
        float bestDist2 = na
        int bestIdx2 = -1
        for i = 0 to bearCount2 - 1
            if array.get(bearActive, i)
                bool already2 = f_isInIntArray(bearVisibleIdx, i)
                if not already2
                    float mid2 = (array.get(bearTops, i) + array.get(bearBots, i)) * 0.5
                    float d2 = math.abs(mid2 - close)
                    if na(bestDist2) or d2 < bestDist2
                        bestDist2 := d2
                        bestIdx2 := i
        if bestIdx2 != -1
            array.push(bearVisibleIdx, bestIdx2)

    for i = 0 to bearCount2 - 1
        box b = array.get(bearBoxes, i)
        line l = array.get(bearLines, i)
        label lab = array.get(bearLabels, i)
        bool isActive = array.get(bearActive, i)
        bool visible = not isActive or f_isInIntArray(bearVisibleIdx, i)

        if not na(b)
            if isActive and not visible
                box.set_bgcolor(b, color.new(bearBase,100))
                box.set_border_color(b, color.new(bearBorder,100))
            else
                box.set_bgcolor(b, bearColor)
                box.set_border_color(b, bearBorder)
        if not na(l)
            if isActive and not visible
                line.set_color(l, color.new(bearBorder,100))
            else
                line.set_color(l, bearBorder)
        if not na(lab)
            if isActive and not visible
                label.set_text(lab, "")
            else
                label.set_text(lab, "FVG-")
