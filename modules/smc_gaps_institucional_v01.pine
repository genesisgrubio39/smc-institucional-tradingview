//@version=6
indicator("SMC – Gaps Institucional (Módulo Gaps)",overlay=true,max_boxes_count=200,max_lines_count=200,max_labels_count=200)

//----------------------------------------------------
// 0. PERFIL INSTITUCIONAL GAPS
//----------------------------------------------------
string groupPerfil = "0. Perfil institucional Gaps"
bool   useAutoPerfil = input.bool(true,"Usar perfil automático",group=groupPerfil)
string tipoActivoManual = input.string("Index / Futuros","Tipo de activo (manual si desactivas automático)",options=["Index / Futuros","MegaCap / ETF","Acción normal","SmallCap / Baja liquidez","FX / Crypto"],group=groupPerfil)

//----------------------------------------------------
// 0B. CVD INSTITUCIONAL INTERNO (MISMA LÓGICA QUE TU SCRIPT)
//----------------------------------------------------
string groupSesionCvd = "Sesión institucional CVD"
bool   useSesionRTHCvd = input.bool(true,"Reset CVD por sesión RTH",group=groupSesionCvd)
string sesionRTHCvd    = input.session("0930-1600","Horario RTH CVD",group=groupSesionCvd)

int  tRTHCvd      = time(timeframe.period,sesionRTHCvd)
bool inRTHCvd     = not na(tRTHCvd)
bool inicioRTHCvd = inRTHCvd and (na(tRTHCvd[1]) or tRTHCvd < tRTHCvd[1])

string groupDeltaCvd = "Modo cálculo CVD (interno)"
string deltaModeCvd  = input.string("Tick","Modo delta por barra CVD",options=["Tick","Proporcional cuerpo/rango"],group=groupDeltaCvd)

var float cvdInt = na

bool  hasPrevCloseCvd  = not na(close[1])
float rangeBarCvd      = high - low
float bodyBarCvd       = close - open
float deltaTickCvd     = hasPrevCloseCvd ? (close > close[1] ? volume : close < close[1] ? -volume : 0.0) : 0.0
float deltaPropCvd     = rangeBarCvd != 0.0 ? (bodyBarCvd / rangeBarCvd) * volume : 0.0
float deltaBarRawCvd   = deltaModeCvd == "Tick" ? deltaTickCvd : deltaPropCvd
float deltaBarCvd      = useSesionRTHCvd ? (inRTHCvd ? deltaBarRawCvd : 0.0) : deltaBarRawCvd

bool cambioDiaCvd  = dayofmonth != dayofmonth[1]
bool condResetCvd  = useSesionRTHCvd ? inicioRTHCvd : cambioDiaCvd
cvdInt := condResetCvd or na(cvdInt[1]) ? deltaBarCvd : cvdInt[1] + deltaBarCvd

//----------------------------------------------------
// 1. INPUTS – LÓGICA GAP INSTITUCIONAL
//----------------------------------------------------
string groupLogic = "1. Lógica GAP institucional"

int   atrLen           = input.int(14,"Longitud ATR",minval=1,group=groupLogic)
float minGapAtrFactor  = input.float(0.8,"Mínimo tamaño GAP (x ATR)",step=0.05,group=groupLogic)

bool  usePctFilter     = input.bool(true,"Usar filtro por tamaño %",group=groupLogic)
float minGapPct        = input.float(0.4,"Mínimo gap (%) vs cierre previo",step=0.05,group=groupLogic)

bool  useVolFilter     = input.bool(true,"Filtrar por volumen institucional",group=groupLogic)
int   volLen           = input.int(60,"Lookback volumen (barras)",minval=10,group=groupLogic)
float volPercThresh    = input.float(65.0,"Percentil volumen (0–100)",step=1.0,group=groupLogic)
string volFilterMode   = input.string("Percentil exacto","Modo filtro volumen",options=["Percentil exacto","Media x factor"],group=groupLogic)

bool  onlySessionOpen  = input.bool(false,"Sólo gaps en apertura de sesión (intradía)",group=groupLogic)

string gapType         = input.string("True GAP","Tipo de GAP",options=["True GAP","GAP + Inefficiency"],group=groupLogic)
int   maxGaps          = input.int(6,"Máximo GAPs en pantalla",minval=1,maxval=100,group=groupLogic)

//----------------------------------------------------
// 2. INPUTS – DISEÑO GAP + CE
//----------------------------------------------------
string groupVisual = "2. Diseño GAP"

color gapColor        = input.color(color.rgb(89,90,95),"Color GAP",group=groupVisual)
int   transNormal     = input.int(80,"Transparencia GAP activo",minval=0,maxval=100,group=groupVisual)
int   transMitigated  = input.int(95,"Transparencia GAP mitigado (si se deja visible)",minval=0,maxval=100,group=groupVisual)
int   transHighlight  = input.int(60,"Transparencia GAP resaltado",minval=0,maxval=100,group=groupVisual)

bool   markCE         = input.bool(true,"Marcar CE (Consequent Encroachment)",group=groupVisual)
string ceStyleStr     = input.string("Discontinua","Estilo línea CE",options=["Discontinua","Punteada","Sólida"],group=groupVisual)
int    ceTransparency = input.int(60,"Transparencia CE",minval=0,maxval=100,group=groupVisual)

string mitigType      = input.string("Rebalance","Mitigación GAP",options=["Engulf","Rebalance"],group=groupVisual)

bool extendUnfilled   = input.bool(true,"Extender GAP no mitigados",group=groupVisual)
bool highlightInside  = input.bool(true,"Resaltar GAP cuando precio dentro",group=groupVisual)

//----------------------------------------------------
// 3. PERFIL INSTITUCIONAL – AJUSTE DE PARÁMETROS
//----------------------------------------------------
float effMinGapAtr       = minGapAtrFactor
float effMinGapPct       = minGapPct
float effVolPerc         = volPercThresh
bool  effUsePctFilter    = usePctFilter
bool  effUseVolFilter    = useVolFilter
bool  effOnlySessionOpen = onlySessionOpen

if useAutoPerfil
    if tipoActivoManual == "Index / Futuros"
        effMinGapAtr       := 0.7
        effMinGapPct       := 0.3
        effVolPerc         := 60.0
        effUsePctFilter    := true
        effUseVolFilter    := true
        effOnlySessionOpen := false
    else if tipoActivoManual == "MegaCap / ETF"
        effMinGapAtr       := 0.7
        effMinGapPct       := 0.3
        effVolPerc         := 60.0
        effUsePctFilter    := true
        effUseVolFilter    := true
        effOnlySessionOpen := false
    else if tipoActivoManual == "Acción normal"
        effMinGapAtr       := 0.8
        effMinGapPct       := 0.4
        effVolPerc         := 65.0
        effUsePctFilter    := true
        effUseVolFilter    := true
        effOnlySessionOpen := false
    else if tipoActivoManual == "SmallCap / Baja liquidez"
        effMinGapAtr       := 1.0
        effMinGapPct       := 0.6
        effVolPerc         := 70.0
        effUsePctFilter    := true
        effUseVolFilter    := true
        effOnlySessionOpen := false
    else if tipoActivoManual == "FX / Crypto"
        effMinGapAtr       := 0.7
        effMinGapPct       := 0.25
        effVolPerc         := 55.0
        effUsePctFilter    := true
        effUseVolFilter    := false
        effOnlySessionOpen := false

//----------------------------------------------------
// 3B. FILTRO CVD INSTITUCIONAL (OPCIONAL)
//----------------------------------------------------
string groupCvdFilter   = "3. Filtro CVD institucional (opcional)"
bool   useCvdFilter     = input.bool(false,"Usar CVD para validar Gaps",group=groupCvdFilter)
string cvdFilterMode    = input.string("CVD y precio a favor","Condición CVD",options=["CVD y precio a favor","Divergencia"],group=groupCvdFilter)
int    lenCvdTrendGap   = input.int(20,"Longitud tendencia CVD/Precio (Gap)",minval=5,group=groupCvdFilter)

float prNowGap      = ta.linreg(close,lenCvdTrendGap,0)
float prPrevGap     = ta.linreg(close,lenCvdTrendGap,1)
float slopePriceGap = prNowGap - prPrevGap

float cvdNowGap     = ta.linreg(cvdInt,lenCvdTrendGap,0)
float cvdPrevGap    = ta.linreg(cvdInt,lenCvdTrendGap,1)
float slopeCvdGap   = cvdNowGap - cvdPrevGap

bool upPriceGap   = slopePriceGap > 0
bool downPriceGap = slopePriceGap < 0
bool upCvdGap     = slopeCvdGap > 0
bool downCvdGap   = slopeCvdGap < 0

bool cvdPriceAFavorBull = upPriceGap and upCvdGap
bool cvdPriceAFavorBear = downPriceGap and downCvdGap
bool divergBull         = downPriceGap and upCvdGap
bool divergBear         = upPriceGap and downCvdGap

//----------------------------------------------------
// 4. FUNCIONES AUXILIARES
//----------------------------------------------------
f_lineStyle(string str)=>
    style = line.style_solid
    if str == "Punteada"
        style := line.style_dotted
    else if str == "Discontinua"
        style := line.style_dashed
    style

f_volPercentileExact(int len,float perc)=>
    float res = na
    if len > 0 and bar_index >= len - 1
        float[] arr = array.new_float(len,0.0)
        for i = 0 to len - 1
            array.set(arr,i,volume[i])
        array.sort(arr,order.ascending)
        float idxF = perc / 100.0 * (len - 1)
        int   idx  = math.round(idxF)
        idx := math.max(0,math.min(idx,len - 1))
        res := array.get(arr,idx)
    res

var ceStyle = line.style_solid
ceStyle := f_lineStyle(ceStyleStr)

float atrVal  = ta.atr(atrLen)
float volMa   = ta.sma(volume,volLen)

float volThreshExact  = na
float volThreshApprox = na
float volFactorApprox = 0.5 + effVolPerc / 100.0

if effUseVolFilter and bar_index >= volLen - 1
    if volFilterMode == "Percentil exacto"
        volThreshExact := f_volPercentileExact(volLen,effVolPerc)
    else
        volThreshApprox := volMa * volFactorApprox

bool isFirstBarSession = timeframe.isintraday ? ta.change(time("D")) != 0 : false

//----------------------------------------------------
// 5. DETECCIÓN INSTITUCIONAL DE GAP
//----------------------------------------------------
f_detectGap(string gType)=>
    float upTop = na
    float upBot = na
    float dnTop = na
    float dnBot = na
    bool  useIneff = gType == "GAP + Inefficiency"
    if open > close[1]
        upTop := open
        upBot := close[1]
    if open < close[1]
        dnTop := close[1]
        dnBot := open
    if useIneff and open > high[1]
        float iTopUp = open
        float iBotUp = high[1]
        upTop := na(upTop) ? iTopUp : math.max(upTop,iTopUp)
        upBot := na(upBot) ? iBotUp : math.min(upBot,iBotUp)
    if useIneff and open < low[1]
        float iTopDn = low[1]
        float iBotDn = open
        dnTop := na(dnTop) ? iTopDn : math.max(dnTop,iTopDn)
        dnBot := na(dnBot) ? iBotDn : math.min(dnBot,iBotDn)
    if not na(upTop) and not na(upBot) and upTop <= upBot
        upTop := na
        upBot := na
    if not na(dnTop) and not na(dnBot) and dnTop <= dnBot
        dnTop := na
        dnBot := na
    [upTop,upBot,dnTop,dnBot]

//----------------------------------------------------
// 6. ARRAYS PARA BOXES, CE Y LABELS
//----------------------------------------------------
var box[]   gapBoxesBull  = array.new_box()
var box[]   gapBoxesBear  = array.new_box()
var line[]  ceLinesBull   = array.new_line()
var line[]  ceLinesBear   = array.new_line()
var label[] gapLabelsBull = array.new_label()
var label[] gapLabelsBear = array.new_label()

f_trimOldGaps()=>
    while array.size(gapBoxesBull) > maxGaps
        box  b_rm    = array.shift(gapBoxesBull)
        line l_rm    = array.shift(ceLinesBull)
        label lab_rm = array.shift(gapLabelsBull)
        box.delete(b_rm)
        if not na(l_rm)
            line.delete(l_rm)
        if not na(lab_rm)
            label.delete(lab_rm)
    while array.size(gapBoxesBear) > maxGaps
        box  b_rm2    = array.shift(gapBoxesBear)
        line l_rm2    = array.shift(ceLinesBear)
        label lab_rm2 = array.shift(gapLabelsBear)
        box.delete(b_rm2)
        if not na(l_rm2)
            line.delete(l_rm2)
        if not na(lab_rm2)
            label.delete(lab_rm2)

//----------------------------------------------------
// 7. NUEVOS GAPs EN LA BARRA ACTUAL
//----------------------------------------------------
[upTopGap,upBotGap,dnTopGap,dnBotGap] = f_detectGap(gapType)

bool sessionOk = not effOnlySessionOpen or not timeframe.isintraday or isFirstBarSession

// GAP alcista nuevo
if not na(upTopGap) and not na(upBotGap) and sessionOk
    float sizeUp      = upTopGap - upBotGap
    bool  sizeAtrOk   = sizeUp >= effMinGapAtr * atrVal
    float refPriceUp  = close[1] != 0.0 ? close[1] : close
    float sizeUpPct   = refPriceUp != 0.0 ? sizeUp / refPriceUp * 100.0 : 0.0
    bool  pctOk       = not effUsePctFilter or sizeUpPct >= effMinGapPct
    bool  volOk       = true
    if effUseVolFilter
        if volFilterMode == "Percentil exacto"
            volOk := not na(volThreshExact) and volume >= volThreshExact
        else
            volOk := not na(volThreshApprox) and volume >= volThreshApprox
    bool condCvdBull = true
    if useCvdFilter
        condCvdBull := cvdFilterMode == "CVD y precio a favor" ? cvdPriceAFavorBull : divergBull
    if sizeAtrOk and pctOk and volOk and condCvdBull
        box  b  = box.new(bar_index - 1,upTopGap,bar_index,upBotGap,bgcolor=color.new(gapColor,transNormal),border_color=color.new(gapColor,50))
        line ce = na
        if markCE
            float midCE = (upTopGap + upBotGap) * 0.5
            ce := line.new(bar_index - 1,midCE,bar_index,midCE,xloc=xloc.bar_index,extend=extend.none,color=color.new(gapColor,ceTransparency),style=ceStyle)
        float mid  = (upTopGap + upBotGap) * 0.5
        float yLab = mid + (upTopGap - upBotGap) * 0.18
        label lab  = label.new(bar_index,yLab,"GAP+",xloc=xloc.bar_index,yloc=yloc.price,style=label.style_none,size=size.small,textcolor=color.white)
        array.push(gapBoxesBull,b)
        array.push(ceLinesBull,ce)
        array.push(gapLabelsBull,lab)
        f_trimOldGaps()

// GAP bajista nuevo
if not na(dnTopGap) and not na(dnBotGap) and sessionOk
    float sizeDn      = dnTopGap - dnBotGap
    bool  sizeAtrOk2  = sizeDn >= effMinGapAtr * atrVal
    float refPriceDn  = close[1] != 0.0 ? close[1] : close
    float sizeDnPct   = refPriceDn != 0.0 ? sizeDn / refPriceDn * 100.0 : 0.0
    bool  pctOk2      = not effUsePctFilter or sizeDnPct >= effMinGapPct
    bool  volOk2      = true
    if effUseVolFilter
        if volFilterMode == "Percentil exacto"
            volOk2 := not na(volThreshExact) and volume >= volThreshExact
        else
            volOk2 := not na(volThreshApprox) and volume >= volThreshApprox
    bool condCvdBear = true
    if useCvdFilter
        condCvdBear := cvdFilterMode == "CVD y precio a favor" ? cvdPriceAFavorBear : divergBear
    if sizeAtrOk2 and pctOk2 and volOk2 and condCvdBear
        box  b2  = box.new(bar_index - 1,dnTopGap,bar_index,dnBotGap,bgcolor=color.new(gapColor,transNormal),border_color=color.new(gapColor,50))
        line ce2 = na
        if markCE
            float midCE2 = (dnTopGap + dnBotGap) * 0.5
            ce2 := line.new(bar_index - 1,midCE2,bar_index,midCE2,xloc=xloc.bar_index,extend=extend.none,color=color.new(gapColor,ceTransparency),style=ceStyle)
        float mid2  = (dnTopGap + dnBotGap) * 0.5
        float yLab2 = mid2 + (dnTopGap - dnBotGap) * 0.18
        label lab2  = label.new(bar_index,yLab2,"GAP-",xloc=xloc.bar_index,yloc=yloc.price,style=label.style_none,size=size.small,textcolor=color.white)
        array.push(gapBoxesBear,b2)
        array.push(ceLinesBear,ce2)
        array.push(gapLabelsBear,lab2)
        f_trimOldGaps()

//----------------------------------------------------
// 8. ACTUALIZAR ESTADO DE GAPs EXISTENTES
//----------------------------------------------------
// GAPs alcistas
int bullCount = array.size(gapBoxesBull)
if bullCount > 0
    for n = 0 to bullCount - 1
        int   i   = bullCount - 1 - n
        box   b   = array.get(gapBoxesBull,i)
        line  ce  = array.get(ceLinesBull,i)
        label lab = array.get(gapLabelsBull,i)
        float top = box.get_top(b)
        float bot = box.get_bottom(b)
        bool  inside = high > bot and low < top
        bool  mitigNow = false
        if mitigType == "Engulf"
            if low <= bot
                mitigNow := true
        else
            if low <= bot
                mitigNow := true
            else if low < top and low > bot
                top := low
                box.set_top(b,top)
                if not na(ce)
                    float midAdj = (top + bot) * 0.5
                    line.set_y1(ce,midAdj)
                    line.set_y2(ce,midAdj)
        if mitigNow
            box.delete(b)
            if not na(ce)
                line.delete(ce)
            if not na(lab)
                label.delete(lab)
            array.remove(gapBoxesBull,i)
            array.remove(ceLinesBull,i)
            array.remove(gapLabelsBull,i)
        else
            if extendUnfilled
                box.set_right(b,bar_index + 1)
                if not na(ce)
                    line.set_x2(ce,bar_index + 1)
            color bg = color.new(gapColor,transNormal)
            color bc = color.new(gapColor,50)
            if highlightInside and inside
                bg := color.new(gapColor,transHighlight)
                bc := color.new(gapColor,transHighlight)
            box.set_bgcolor(b,bg)
            box.set_border_color(b,bc)
            float midLab = (box.get_top(b) + box.get_bottom(b)) * 0.5
            float yLab   = midLab + (box.get_top(b) - box.get_bottom(b)) * 0.18
            if not na(lab)
                label.set_x(lab,box.get_right(b))
                label.set_y(lab,yLab)
                label.set_text(lab,"GAP+")
                label.set_textcolor(lab,color.white)
            if not na(ce)
                line.set_color(ce,color.new(bc,ceTransparency))

// GAPs bajistas
int bearCount = array.size(gapBoxesBear)
if bearCount > 0
    for n = 0 to bearCount - 1
        int   j    = bearCount - 1 - n
        box   b3   = array.get(gapBoxesBear,j)
        line  ce3  = array.get(ceLinesBear,j)
        label lab3 = array.get(gapLabelsBear,j)
        float top3 = box.get_top(b3)
        float bot3 = box.get_bottom(b3)
        bool  inside3 = high > bot3 and low < top3
        bool  mitigNow3 = false
        if mitigType == "Engulf"
            if high >= top3
                mitigNow3 := true
        else
            if high >= top3
                mitigNow3 := true
            else if high > bot3 and high < top3
                bot3 := high
                box.set_bottom(b3,bot3)
                if not na(ce3)
                    float midAdj3 = (top3 + bot3) * 0.5
                    line.set_y1(ce3,midAdj3)
                    line.set_y2(ce3,midAdj3)
        if mitigNow3
            box.delete(b3)
            if not na(ce3)
                line.delete(ce3)
            if not na(lab3)
                label.delete(lab3)
            array.remove(gapBoxesBear,j)
            array.remove(ceLinesBear,j)
            array.remove(gapLabelsBear,j)
        else
            if extendUnfilled
                box.set_right(b3,bar_index + 1)
                if not na(ce3)
                    line.set_x2(ce3,bar_index + 1)
            color bg3 = color.new(gapColor,transNormal)
            color bc3 = color.new(gapColor,50)
            if highlightInside and inside3
                bg3 := color.new(gapColor,transHighlight)
                bc3 := color.new(gapColor,transHighlight)
            box.set_bgcolor(b3,bg3)
            box.set_border_color(b3,bc3)
            float midLab3 = (box.get_top(b3) + box.get_bottom(b3)) * 0.5
            float yLab3   = midLab3 + (box.get_top(b3) - box.get_bottom(b3)) * 0.18
            if not na(lab3)
                label.set_x(lab3,box.get_right(b3))
                label.set_y(lab3,yLab3)
                label.set_text(lab3,"GAP-")
                label.set_textcolor(lab3,color.white)
            if not na(ce3)
                line.set_color(ce3,color.new(bc3,ceTransparency))
